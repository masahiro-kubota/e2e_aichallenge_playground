# MPC-Based Trajectory Planner

Model Predictive Control (MPC) ãƒ™ãƒ¼ã‚¹ã®è»Œé“è¨ˆç”»å™¨ã€‚é™çš„ãªé•·æ–¹å½¢éšœå®³ç‰©ã‚’å›é¿ã—ãªãŒã‚‰ã€å‚ç…§çµŒè·¯ã«æ²¿ã£ãŸæœ€é©ãªå±€æ‰€è»Œé“ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

## Overview

### Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MPC Planner (Planningå±¤)           â”‚
â”‚  - éšœå®³ç‰©å›é¿ã‚’è€ƒæ…®ã—ãŸè»Œé“ç”Ÿæˆ      â”‚
â”‚  - å‡ºåŠ›: Trajectory                  â”‚
â”‚    (ç›®æ¨™ä½ç½®ãƒ»é€Ÿåº¦ã®æ™‚ç³»åˆ—)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ Trajectory
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PID Controller (Controlå±¤)         â”‚
â”‚  - è»Œé“è¿½å¾“åˆ¶å¾¡                      â”‚
â”‚  - å‡ºåŠ›: åŠ é€Ÿåº¦æŒ‡ä»¤                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Key Features

- **Receding Horizon Planning**: ä¸€å®šè·é›¢ã”ã¨ã«å±€æ‰€çš„ãªæœ€é©è»Œé“ã‚’å†è¨ˆç”»
- **Obstacle Avoidance**: é•·æ–¹å½¢éšœå®³ç‰©ã¨ã®è¡çªã‚’å›é¿ã™ã‚‹åˆ¶ç´„ã‚’çµ„ã¿è¾¼ã¿
- **Vehicle Dynamics**: è»Šä¸¡ã®é‹å‹•å­¦ãƒ¢ãƒ‡ãƒ«ã‚’è€ƒæ…®ã—ãŸå®Ÿè¡Œå¯èƒ½ãªè»Œé“ç”Ÿæˆ
- **CasADi Optimization**: éç·šå½¢æœ€é©åŒ–ã‚½ãƒ«ãƒãƒ¼(IPOPT)ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªè§£

## Configuration

### Basic Usage

```bash
# MPC plannerã‚’ä½¿ç”¨ã—ã¦å®Ÿé¨“ã‚’å®Ÿè¡Œ
uv run experiment-runner experiment=evaluation env=randomized2 agent=mpc
```

### Parameters

è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: `experiment/conf/agent/mpc.yaml`

```yaml
planning:
  horizon_distance: 30.0        # è¨ˆç”»ãƒ›ãƒ©ã‚¤ã‚ºãƒ³è·é›¢ [m]
  horizon_num_points: 50        # é›¢æ•£åŒ–ç‚¹æ•°
  trigger_distance: 10.0        # å†è¨ˆç”»ãƒˆãƒªã‚¬ãƒ¼è·é›¢ [m]
  
  max_iterations: 100           # ã‚½ãƒ«ãƒãƒ¼æœ€å¤§åå¾©æ•°
  solver_timeout: 1.0           # ã‚½ãƒ«ãƒãƒ¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ [s]
  
  collision_method: "four_corners"  # è¡çªå›é¿æ‰‹æ³•
  safety_margin: 0.3            # å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³ [m]
  
  weight_progress: 1.0          # å‰é€²ã®é‡ã¿
  weight_deviation: 0.5         # å‚ç…§çµŒè·¯ã‹ã‚‰ã®é€¸è„±ãƒšãƒŠãƒ«ãƒ†ã‚£
  weight_smoothness: 0.1        # æ»‘ã‚‰ã‹ã•ã®é‡ã¿
```

## Collision Avoidance Methods

3ã¤ã®è¡çªå›é¿æ‰‹æ³•ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚è©³ç´°ã¯ [collision_avoidance_options.md](collision_avoidance_options.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Option 1: Circle Approximation (å††å½¢åŒ…çµ¡ç·šè¿‘ä¼¼)

**ç²¾åº¦**: â­â­â˜†â˜†â˜†  
**è¨ˆç®—æ™‚é–“**: â­â­â­â­â­  
**å®Ÿè£…çŠ¶æ³**: âœ… å®Ÿè£…æ¸ˆã¿(æ¯”è¼ƒç”¨)

é•·æ–¹å½¢ã‚’åŒ…ã‚€å††ã§è¿‘ä¼¼ã€‚æœ€ã‚‚é«˜é€Ÿã ãŒä¿å®ˆçš„ã€‚ç‹­ã„éš™é–“ã¯é€šã‚Œãªã„å¯èƒ½æ€§ã‚ã‚Šã€‚

### Option 2: Four Corners Distance (è»Šä¸¡4éš…è·é›¢) â† **ç¾åœ¨ã®å®Ÿè£…**

**ç²¾åº¦**: â­â­â­â­â˜†  
**è¨ˆç®—æ™‚é–“**: â­â­â­â˜†â˜†  
**å®Ÿè£…çŠ¶æ³**: âœ… å®Ÿè£…æ¸ˆã¿(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)

è»Šä¸¡ã®4éš…ãŒå…¨ã¦ã®éšœå®³ç‰©ã‹ã‚‰é›¢ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ä¿è¨¼ã€‚ç²¾åº¦ã¨é€Ÿåº¦ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ã€‚

### Option 3: Separating Axis Theorem (SAT)

**ç²¾åº¦**: â­â­â­â­â­  
**è¨ˆç®—æ™‚é–“**: â­â­â˜†â˜†â˜†  
**å®Ÿè£…çŠ¶æ³**: ğŸ“‹ å°†æ¥å®Ÿè£…äºˆå®š

é•·æ–¹å½¢é–“ã®æ­£ç¢ºãªè·é›¢ã‚’è¨ˆç®—ã€‚æœ€ã‚‚æ­£ç¢ºã ãŒè¨ˆç®—ã‚³ã‚¹ãƒˆãŒé«˜ã„ã€‚

## Performance

### Expected Computation Time

| ãƒ›ãƒ©ã‚¤ã‚ºãƒ³è·é›¢ | é›¢æ•£ç‚¹æ•° | éšœå®³ç‰©æ•° | äºˆæƒ³æ±‚è§£æ™‚é–“ |
|--------------|---------|---------|------------|
| 20m | 30ç‚¹ | 10å€‹ | 0.1-0.5ç§’ |
| 30m | 50ç‚¹ | 10å€‹ | 0.3-1.0ç§’ |
| 50m | 80ç‚¹ | 10å€‹ | 0.5-2.0ç§’ |

## Implementation Details

### Components

- **`mpc_planner_node.py`**: ãƒ¡ã‚¤ãƒ³ã®ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ãƒãƒ¼ãƒ‰
- **`vehicle_model.py`**: è»Šä¸¡é‹å‹•å­¦ãƒ¢ãƒ‡ãƒ«(Kinematic Bicycle Model)
- **`collision_checker.py`**: è¡çªåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

### Optimization Problem

**æ±ºå®šå¤‰æ•°**:
- çŠ¶æ…‹: `[x, y, Î¸, v]` (å„æ™‚åˆ»)
- åˆ¶å¾¡å…¥åŠ›: `[a, Î´]` (åŠ é€Ÿåº¦ã€æ“èˆµè§’)

**ç›®çš„é–¢æ•°**:
```
minimize:
  + weight_deviation * Î£(deviation from reference)^2
  - weight_progress * Î£(forward progress)
  + weight_smoothness * Î£(control changes)^2
```

**åˆ¶ç´„**:
- è»Šä¸¡é‹å‹•å­¦ãƒ¢ãƒ‡ãƒ«(ç­‰å¼åˆ¶ç´„)
- é€Ÿåº¦ãƒ»åŠ é€Ÿåº¦ãƒ»æ“èˆµè§’ã®åˆ¶é™(ä¸ç­‰å¼åˆ¶ç´„)
- éšœå®³ç‰©å›é¿(ä¸ç­‰å¼åˆ¶ç´„)

## Testing

### Unit Tests

```bash
# è¡çªåˆ¤å®šã®ãƒ†ã‚¹ãƒˆ
PYTHONPATH="" uv run pytest ad_components/planning/mpc_planner/tests/test_collision_checker.py -v

# è»Šä¸¡ãƒ¢ãƒ‡ãƒ«ã®ãƒ†ã‚¹ãƒˆ
PYTHONPATH="" uv run pytest ad_components/planning/mpc_planner/tests/test_vehicle_model.py -v
```

### Integration Tests

```bash
# çµ±åˆãƒ†ã‚¹ãƒˆ(å¿…é ˆ)
PYTHONPATH="" uv run pytest -m integration -v -s
```

## Troubleshooting

### Optimization Fails

æœ€é©åŒ–ãŒå¤±æ•—ã™ã‚‹å ´åˆã€ä»¥ä¸‹ã‚’ç¢ºèª:

1. **ãƒ›ãƒ©ã‚¤ã‚ºãƒ³ãŒé•·ã™ãã‚‹**: `horizon_distance`ã‚’çŸ­ãã™ã‚‹
2. **éšœå®³ç‰©ãŒå¯†é›†ã—ã¦ã„ã‚‹**: `safety_margin`ã‚’å°ã•ãã™ã‚‹
3. **åˆæœŸæ¨å®šå€¤ãŒæ‚ªã„**: å‚ç…§çµŒè·¯ã®å“è³ªã‚’ç¢ºèª

### Computation Time Too Long

è¨ˆç®—æ™‚é–“ãŒé•·ã„å ´åˆ:

1. **é›¢æ•£ç‚¹æ•°ã‚’æ¸›ã‚‰ã™**: `horizon_num_points`ã‚’æ¸›ã‚‰ã™
2. **ãƒ›ãƒ©ã‚¤ã‚ºãƒ³ã‚’çŸ­ãã™ã‚‹**: `horizon_distance`ã‚’çŸ­ãã™ã‚‹
3. **è¡çªå›é¿æ‰‹æ³•ã‚’å¤‰æ›´**: `collision_method: "circle"`ã«å¤‰æ›´

## Future Work

- [ ] Option 3 (SAT) ã®å®Ÿè£…
- [ ] é©å¿œçš„ãƒ›ãƒ©ã‚¤ã‚ºãƒ³(éšœå®³ç‰©å¯†åº¦ã«å¿œã˜ã¦èª¿æ•´)
- [ ] ã‚¦ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ(å‰å›ã®è§£ã‚’åˆæœŸå€¤ã«ä½¿ç”¨)
- [ ] ä¸¦åˆ—åŒ–(è¤‡æ•°å€™è£œçµŒè·¯ã‚’ä¸¦åˆ—è¨ˆç®—)
- [ ] å‹•çš„éšœå®³ç‰©ã¸ã®å¯¾å¿œ

## References

- CasADi: https://web.casadi.org/
- IPOPT: https://coin-or.github.io/Ipopt/
