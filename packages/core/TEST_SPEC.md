# Coreパッケージ テスト仕様書

このドキュメントでは、`packages/core`に含まれるテストケースの検証内容を定義します。

## 1. データ構造 (`tests/test_data.py`)

自動運転で使用する基本データ構造の動作検証。

| テスト対象クラス | 検証項目 | 内容 |
|------------------|----------|------|
| **VehicleState** | 作成と初期化 | 全フィールド（x, y, yaw, v等）が正しく設定されるか |
| | 配列変換 | `to_array()`で正しい順序のnumpy配列が生成されるか |
| | 配列復元 | `from_array()`でnumpy配列からオブジェクトが復元できるか |
| | 整合性 | 変換→復元を行っても値が変化しないか（Roundtrip） |
| **Observation** | 作成と初期化 | 観測データ（偏差、速度等）が正しく設定されるか |
| | 配列変換・復元 | numpy配列との相互変換が正しく行われるか |
| **Action** | 作成と初期化 | 制御指令（ステアリング、加速度）が正しく設定されるか |
| | 配列変換・復元 | numpy配列との相互変換が正しく行われるか |
| **Trajectory** | 作成 | 軌道点リストからオブジェクトが生成できるか |
| | インデックス | リストのようにインデックスアクセス（`traj[i]`）できるか |
| | 一括変換 | `to_arrays()`でx, y, yaw, vそれぞれのnumpy配列を取得できるか |
| | エッジケース | 空のリストで初期化してもエラーにならないか |

## 2. 幾何計算ユーティリティ (`tests/test_geometry.py`)

幾何学的な計算を行う関数の精度とエッジケース検証。

| テスト対象関数 | 検証項目 | 内容 |
|----------------|----------|------|
| **normalize_angle** | ゼロ・小角度 | 0や微小な角度がそのまま返るか |
| | 大角度（正/負） | $2\pi$を超える角度が $[-\pi, \pi]$ に正規化されるか |
| | 境界値 | $\pi$ や $-\pi$ の扱いが正しいか |
| **distance** | 基本距離 | 水平、垂直、対角（3-4-5三角形）の距離計算 |
| | 特殊ケース | 同一点（距離0）、負の座標を含む場合の計算 |
| **angle_between_points** | 各方向 | 右(0)、上($\pi/2$)、左($\pi$)、下($-\pi/2$)の角度計算 |
| **rotate_point** | 回転 | 0度、90度、180度の回転後の座標確認 |
| | 任意原点 | 原点以外を中心とした回転計算 |
| **nearest_point_on_line** | 線分上の点 | 点が線分上にある場合、その点が返るか |
| | 垂直射影 | 点から線分へ下ろした垂線の足が返るか |
| | 端点外側 | 垂線の足が線分外の場合、近い方の端点が返るか |
| **curvature_from_points** | 直線 | 一直線上の3点で曲率0になるか |
| | 直角・円 | 直角や円周上の3点で正しい曲率（$1/R$）が計算されるか |

## 3. 座標変換ユーティリティ (`tests/test_transforms.py`)

グローバル座標系とローカル座標系の相互変換検証。

| テスト対象関数 | 検証項目 | 内容 |
|----------------|----------|------|
| **global_to_local** | 基本変換 | 平行移動のみ、回転のみ、複合変換で正しいローカル座標になるか |
| **local_to_global** | 基本変換 | 平行移動のみ、回転のみ、複合変換で正しいグローバル座標になるか |
| | 整合性 | Global→Local→Global変換で元の座標に戻るか |
| **transform_angle** | 角度変換 | グローバル⇔ローカル間の角度変換（座標系の回転を考慮） |
| | 整合性 | 往復変換で元の角度に戻るか |
| **rotation_matrix_2d** | 行列生成 | 指定角度の正しい2x2回転行列が生成されるか |
| | ベクトル回転 | 生成した行列でベクトルを回転させ、結果が正しいか |
| **transformation_matrix_2d** | 行列生成 | 平行移動と回転を含む3x3同次変換行列の生成 |
| | 座標変換 | 生成した行列で点（同次座標）を変換し、結果が正しいか |

## 4. 設定管理ユーティリティ (`tests/test_config.py`)

YAML設定ファイルの読み書きと操作の検証。

| テスト対象関数 | 検証項目 | 内容 |
|----------------|----------|------|
| **load/save_yaml** | I/O操作 | 辞書データの保存と読み込みが一致するか |
| | エラー処理 | 存在しないファイルを読もうとした際にエラーになるか |
| | 構造 | ネストした辞書や空ファイルが正しく扱えるか |
| **merge_configs** | マージ動作 | ベース設定を上書き設定で正しく更新できるか |
| | ネスト | 深い階層の設定も再帰的にマージされるか |
| | 非破壊 | マージ操作が元の辞書を変更しないか |
| **get_nested_value** | 値取得 | ドット区切りパス（`a.b.c`）で深層の値を取得できるか |
| | デフォルト値 | キーが存在しない場合にデフォルト値またはNoneが返るか |
| **set_nested_value** | 値設定 | ドット区切りパスで深層の値を設定・更新できるか |
| | 自動生成 | 中間のキーが存在しない場合、自動的に辞書を作成するか |
| **Integration** | ワークフロー | 設定定義→マージ→値取得→更新→保存→読込の一連の流れ |

## 5. インターフェースと統合 (`tests/test_interfaces.py`)

抽象インターフェースとコンポーネント連携の検証。

| テスト対象 | 検証項目 | 内容 |
|------------|----------|------|
| **各コンポーネント** | 実装要件 | 抽象クラスを継承したダミー実装が正しく動作するか |
| (Perception, Planning, Control) | 入出力型 | 各メソッドが規定の型（Observation, Action等）を入出力するか |
| **Simulator** | 状態遷移 | `reset()`で初期化、`step()`で状態更新ができるか |
| **Pipeline** | 統合動作 | 認識→計画→制御→シミュレータの一連のループが回るか |
| | データフロー | 各コンポーネント間でデータ（観測、軌道、指令）が正しく渡るか |
